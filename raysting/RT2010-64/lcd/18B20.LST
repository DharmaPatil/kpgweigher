C51 COMPILER V7.01  18B20                                                                  08/09/2010 20:39:09 PAGE 1   


C51 COMPILER V7.01, COMPILATION OF MODULE 18B20
OBJECT MODULE PLACED IN 18B20.OBJ
COMPILER INVOKED BY: F:\GreenTools\Keil\C51\BIN\C51.EXE 18B20.c LARGE BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /************************************************************
   2          18B20驱动程序，DQ为数据口，接于P3.5
   3          11.0592M晶振，上拉4.7k电阻
   4          *************************************************************/
   5          #include "stc51.h"
   6          #include "intrins.h"
   7          #include "utili.h"
   8          
   9          
  10          sbit dq = P3^5;
  11          
  12          u8 temp_buff[9]; //存储读取的字节，read scratchpad为9字节，read rom ID为8字节
  13          u8 *p;
  14          u8 code CrcTable [256]={
  15          0,  94, 188,  226,  97,  63,  221,  131,  194,  156,  126,  32,  163,  253,  31,  65,
  16          157,  195,  33,  127,  252,  162,  64,  30,  95,  1,  227,  189,  62,  96,  130,  220,
  17          35,  125,  159,  193,  66,  28,  254,  160,  225,  191,  93,  3,  128,  222,  60,  98,
  18          190,  224,  2,  92,  223,  129,  99,  61,  124,  34,  192,  158,  29,  67,  161,  255,
  19          70,  24,  250,  164,  39,  121,  155,  197,  132,  218,  56,  102,  229,  187,  89,  7,
  20          219,  133, 103,  57,  186,  228,  6,  88,  25,  71,  165,  251,  120,  38,  196,  154,
  21          101,  59, 217,  135,  4,  90,  184,  230,  167,  249,  27,  69,  198,  152,  122,  36,
  22          248,  166, 68,  26,  153,  199,  37,  123,  58,  100,  134,  216,  91,  5,  231,  185,
  23          140,  210, 48,  110,  237,  179,  81,  15,  78,  16,  242,  172,  47,  113,  147,  205,
  24          17,  79,  173,  243,  112,  46,  204,  146,  211,  141,  111,  49,  178,  236,  14,  80,
  25          175,  241, 19,  77,  206,  144,  114,  44,  109,  51,  209,  143,  12,  82,  176,  238,
  26          50,  108,  142,  208,  83,  13,  239,  177,  240,  174,  76,  18,  145,  207,  45,  115,
  27          202,  148, 118,  40,  171,  245,  23,  73,  8,  86,  180,  234,  105,  55,  213, 139,
  28          87,  9,  235,  181,  54,  104,  138,  212,  149,  203,  41,  119,  244,  170,  72,  22,
  29          233,  183,  85,  11,  136,  214,  52,  106,  43,  117,  151,  201,  74,  20,  246,  168,
  30          116,  42,  200,  150,  21,  75,  169,  247,  182,  232,  10,  84,  215,  137,  107,  53};
  31          //
  32          /************************************************************
  33          *Function:延时处理
  34          *parameter:
  35          *Return:
  36          *Modify:
  37          *************************************************************/
  38          void TempDelay (u8 us)
  39          {
  40   1        while(us--);
  41   1      }
  42          /************************************************************
  43          *Function:18B20初始化
  44          *parameter:
  45          *Return:
  46          *Modify:
  47          *************************************************************/
  48          u8 Start18b20 (void)
  49          {
  50   1       u8 flag = 0;
  51   1       dq=1;
  52   1       _nop_();
  53   1       dq=0;
  54   1       TempDelay(86);   //delay 530 uS//80
  55   1       _nop_();
C51 COMPILER V7.01  18B20                                                                  08/09/2010 20:39:09 PAGE 2   

  56   1       dq=1;
  57   1       TempDelay(14);   //delay 100 uS//14
  58   1       _nop_();
  59   1       _nop_();
  60   1       _nop_();
  61   1       
  62   1       
  63   1       if(dq==0)
  64   1        flag = 1;   //detect 1820 success!
  65   1       else
  66   1        flag = 0;    //detect 1820 fail!
  67   1       
  68   1       TempDelay(20);       //20
  69   1       _nop_();
  70   1       _nop_();
  71   1       dq = 1;
  72   1       return flag;
  73   1      }
  74          /************************************************************
  75          *Function:向18B20写入一个字节
  76          *parameter:
  77          *Return:
  78          *Modify:
  79          *************************************************************/
  80          void WriteByte (u8 wr)  //单字节写入
  81          {
  82   1       u8 i;
  83   1       for (i=0;i<8;i++)
  84   1       {
  85   2        dq = 0;
  86   2        _nop_();
  87   2        dq=wr&0x01;
  88   2        TempDelay(5);   //delay 45 uS //5
  89   2        _nop_();
  90   2        _nop_();
  91   2        dq=1;
  92   2        wr >>= 1;
  93   2       }
  94   1      }
  95          /************************************************************
  96          *Function:读18B20的一个字节
  97          *parameter:
  98          *Return:
  99          *Modify:
 100          *************************************************************/
 101          u8 ReadByte (void)     //读取单字节
 102          {
 103   1       u8 i,u=0;
 104   1       for(i=0;i<8;i++)
 105   1       {
 106   2        dq = 0;
 107   2        u >>= 1;
 108   2        dq = 1;
 109   2        if(dq==1)
 110   2        u |= 0x80;
 111   2        TempDelay (4);
 112   2        _nop_();
 113   2       }
 114   1       return(u);
 115   1      }
 116          /************************************************************
 117          *Function:读18B20
C51 COMPILER V7.01  18B20                                                                  08/09/2010 20:39:09 PAGE 3   

 118          *parameter:
 119          *Return:
 120          *Modify:
 121          *************************************************************/
 122          void drop_bytes (u8 j)   //读出J个数据并丢弃
 123          {
 124   1        while(j > 0){
 125   2          ReadByte();
 126   2              j--;
 127   2        }
 128   1      }
 129          
 130          /************************************************************
 131          *Function:读18B20
 132          *parameter:
 133          *Return:
 134          *Modify:
 135          *************************************************************/
 136          void read_bytes (u8 j)   //读出J个数据并存放在p指向的缓冲区
 137          {
 138   1        u8 i;
 139   1        for(i=0;i<j;i++)
 140   1        {
 141   2          *p = ReadByte();
 142   2          p++;
 143   2        }
 144   1      }
 145          /************************************************************
 146          *Function:CRC校验
 147          *parameter:
 148          *Return:
 149          *Modify:
 150          *************************************************************/
 151          u8 CRC(u8 j)
 152          {
 153   1          u8 i,crc_data=0;
 154   1         for(i=0;i<j;i++)  //查表校验
 155   1           crc_data = CrcTable[crc_data^temp_buff[i]];
 156   1          return (crc_data);
 157   1      }
 158          /************************************************************
 159          *Function:内部配置
 160          *parameter:
 161          *Return:
 162          *Modify:
 163          *************************************************************/
 164          void Config18b20 (void)  //重新配置报警限定值和分辨率
 165          {
 166   1           Start18b20();
 167   1           WriteByte(0xcc);  //skip rom
 168   1           WriteByte(0x4e);  //write scratchpad
 169   1           WriteByte(0x0);   //上限
 170   1           WriteByte(0x64);  //下限
 171   1           WriteByte(0x7f);  //set 11 bit (0.125)
 172   1           Start18b20();
 173   1           WriteByte(0xcc);  //skip rom
 174   1           WriteByte(0x48);  //保存设定值
 175   1           Start18b20();
 176   1           WriteByte(0xcc);  //skip rom
 177   1           WriteByte(0xb8);  //回调设定值
 178   1      }
 179          /************************************************************
C51 COMPILER V7.01  18B20                                                                  08/09/2010 20:39:09 PAGE 4   

 180          *Function:读18B20ID
 181          *parameter:
 182          *Return:
 183          *Modify:
 184          *************************************************************/
 185          void ReadID (void)//读取器件 id
 186          {
 187   1       Start18b20();
 188   1       WriteByte(0x33);  //read rom
 189   1       drop_bytes(8);
 190   1      }
 191          /************************************************************
 192          *Function:18B20ID全处理
 193          *parameter:
 194          *Return:
 195          *Modify:
 196          *************************************************************/
 197          void Init_18b20(void)
 198          {
 199   1         ReadID();
 200   1         Config18b20();
 201   1         Start18b20();
 202   1         WriteByte(0xcc);   //skip rom
 203   1         WriteByte(0x44);   //Temperature convert
 204   1         Start18b20();
 205   1         WriteByte(0xcc);   //skip rom                              
 206   1         WriteByte(0xbe);   //read Temperature
 207   1      
 208   1         p = temp_buff;
 209   1         read_bytes (9);
 210   1         if (CRC(9)==0) //校验正确
 211   1         {
 212   2           rdata.Temp1820 = temp_buff[1]*0x100 + temp_buff[0];
 213   2               rdata.Temp1820 = rdata.Temp1820/16.0;
 214   2          }
 215   1      } 
 216          
 217          void get_18b20()
 218          {
 219   1              Start18b20 ();
 220   1              WriteByte(0xcc);   //skip rom
 221   1              WriteByte(0x44);   //Temperature convert
 222   1              Start18b20 ();
 223   1              WriteByte(0xcc);   //skip rom                         
 224   1              WriteByte(0xbe);   //read Temperature
 225   1              p = temp_buff;
 226   1              read_bytes (9);
 227   1          if (CRC(9)==0) //校验正确
 228   1          {
 229   2            rdata.Temp1820 = temp_buff[1]*0x100 + temp_buff[0];
 230   2                rdata.Temp1820 = rdata.Temp1820/16.0;
 231   2          }
 232   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    448    ----
   CONSTANT SIZE    =    256    ----
   XDATA SIZE       =     12       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V7.01  18B20                                                                  08/09/2010 20:39:09 PAGE 5   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
